/* This file was generated by the Hex-Rays decompiler version 8.3.0.230608.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

void *init_proc();
int sub_8049030();
// int __cdecl __libc_start_main(int (__cdecl *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end);
// int fflush(FILE *stream);
// char *fgets(char *s, int n, FILE *stream);
// int fclose(FILE *stream);
// time_t time(time_t *timer);
// __pid_t getpid(void);
// int puts(const char *s);
// clock_t clock(void);
// void exit(int status);
// void srand(unsigned int seed);
// FILE *fopen(const char *filename, const char *modes);
// int rand(void);
// int __printf_chk(_DWORD, const char *, ...); weak
// int __isoc99_scanf(const char *, ...); weak
// int strncmp(const char *s1, const char *s2, size_t n);
// int getc(FILE *stream);
// void __usercall __noreturn start(int a1@<eax>, void (*a2)(void)@<edx>);
void sub_804916D();
void dl_relocate_static_pie();
void _x86_get_pc_thunk_bx();
void *deregister_tm_clones();
int register_tm_clones();
void *_do_global_dtors_aux();
int frame_dummy();
void __cdecl __noreturn win(int a1);
int lose();
int flush_stdin();
int loop();
unsigned int __cdecl mix(int a1, int a2, unsigned int a3);
int __cdecl main(int argc, const char **argv, const char **envp);
void term_proc();

//-------------------------------------------------------------------------
// Data declarations

int (*dword_804C008)(void) = NULL; // weak
_UNKNOWN _bss_start; // weak
FILE *stdin; // idb
FILE *stdout; // idb
char completed_0; // weak
char cur_user[36]; // idb
int dword_804C0A4; // weak
int dword_804C0A8; // weak
int dword_804C0AC; // weak
// extern _UNKNOWN _gmon_start__; weak


//----- (08049000) --------------------------------------------------------
void *init_proc()
{
  void *result; // eax

  result = &_gmon_start__;
  if ( &_gmon_start__ )
    return (void *)((int (*)(void))_gmon_start__)();
  return result;
}

//----- (08049030) --------------------------------------------------------
int sub_8049030()
{
  return dword_804C008();
}
// 804C008: using guessed type int (*dword_804C008)(void);

//----- (08049140) --------------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __usercall __noreturn start(int a1@<eax>, void (*a2)(void)@<edx>)
{
  int v2; // esi
  int v3; // [esp-4h] [ebp-4h] BYREF
  char *retaddr; // [esp+0h] [ebp+0h] BYREF

  v2 = v3;
  v3 = a1;
  __libc_start_main((int (__cdecl *)(int, char **, char **))main, v2, &retaddr, 0, 0, a2, &v3);
  __halt();
}
// 8049147: positive sp value 4 has been found

//----- (0804916D) --------------------------------------------------------
void sub_804916D()
{
  ;
}

//----- (08049180) --------------------------------------------------------
void dl_relocate_static_pie()
{
  ;
}

//----- (08049190) --------------------------------------------------------
void _x86_get_pc_thunk_bx()
{
  ;
}

//----- (080491A0) --------------------------------------------------------
void *deregister_tm_clones()
{
  return &_bss_start;
}
// 80491A0: could not find valid save-restore pair for ebp

//----- (080491E0) --------------------------------------------------------
int register_tm_clones()
{
  return 0;
}
// 80491E0: could not find valid save-restore pair for ebp

//----- (08049220) --------------------------------------------------------
void *_do_global_dtors_aux()
{
  void *result; // eax

  if ( !completed_0 )
  {
    result = deregister_tm_clones();
    completed_0 = 1;
  }
  return result;
}
// 8049220: could not find valid save-restore pair for ebp
// 804C068: using guessed type char completed_0;

//----- (08049250) --------------------------------------------------------
int frame_dummy()
{
  return register_tm_clones();
}

//----- (08049256) --------------------------------------------------------
void __cdecl __noreturn win(int a1)
{
  FILE *v1; // eax
  FILE *v2; // esi
  char s[112]; // [esp+1Ch] [ebp-70h] BYREF

  if ( dword_804C0A4 != a1 )
  {
    puts("You shall not pass!");
    fflush(stdout);
    exit(2);
  }
  v1 = fopen("flag", "r");
  v2 = v1;
  if ( v1 )
  {
    fgets(s, 99, v1);
    fclose(v2);
    if ( dword_804C0A4 != a1 )
    {
      puts("Did you just bypass the first magic check? Not again! ");
      fflush(stdout);
      exit(2);
    }
    puts(s);
    exit(0);
  }
  puts("File opening failed!\nNote: there is no flag available locally, try it on the remote server!");
  fflush(stdout);
  exit(1);
}
// 804C0A4: using guessed type int dword_804C0A4;

//----- (08049336) --------------------------------------------------------
int lose()
{
  puts("Sorry, you lost all your money :( ");
  puts("https://www.youtube.com/watch?v=SIqkZIwa9cw");
  return -2;
}

//----- (08049358) --------------------------------------------------------
int flush_stdin()
{
  int result; // eax

  do
    result = getc(stdin);
  while ( result != 10 && result != -1 );
  return result;
}

//----- (0804937A) --------------------------------------------------------
int loop()
{
  unsigned int i; // esi
  int v1; // edi
  unsigned int j; // ecx
  int v3; // eax
  unsigned int v5; // [esp+1Ch] [ebp-100h]
  char v6[2]; // [esp+23h] [ebp-F9h] BYREF
  unsigned __int8 v7; // [esp+25h] [ebp-F7h]
  int v8; // [esp+27h] [ebp-F5h]
  int v9; // [esp+2Bh] [ebp-F1h]
  int v10; // [esp+2Fh] [ebp-EDh]
  int v11; // [esp+33h] [ebp-E9h]
  int v12; // [esp+37h] [ebp-E5h]
  unsigned __int8 v13; // [esp+3Bh] [ebp-E1h]
  int v14[36]; // [esp+3Ch] [ebp-E0h] BYREF
  int v15; // [esp+CFh] [ebp-4Dh]
  int v16; // [esp+D3h] [ebp-49h]
  int v17; // [esp+D7h] [ebp-45h]
  int v18; // [esp+DBh] [ebp-41h]
  int v19; // [esp+DFh] [ebp-3Dh]
  int v20; // [esp+E3h] [ebp-39h]
  int v21; // [esp+E7h] [ebp-35h]
  int v22; // [esp+EBh] [ebp-31h]
  int v23; // [esp+EFh] [ebp-2Dh]
  int v24; // [esp+F3h] [ebp-29h]
  int v25; // [esp+F7h] [ebp-25h]
  int v26; // [esp+FBh] [ebp-21h]
  char v27; // [esp+FFh] [ebp-1Dh]

  dword_804C0A4 = (rand() % 201527) | 0x80808080;
  __printf_chk(1, "Welcome, %s!\n", cur_user);
  __printf_chk(1, "Your balance: $%d\n", dword_804C0A8);
  fflush(stdout);
  puts("\nPlease enter the list of numbers you want to roll (write 'x' to stop): ");
  fflush(stdout);
  for ( i = 0; __isoc99_scanf("%u", &v14[i]) > 0; ++i )
    ;
  flush_stdin();
  v5 = 0;
  v1 = 0;
  while ( v5 < i )
  {
    v3 = rand();
    for ( j = 0; j < i; ++j )
    {
      if ( v14[j] % 0x64u == v3 % 100 )
        ++v1;
    }
    ++v5;
  }
  v15 = 16843009 * (unsigned __int8)v1;
  v16 = v15;
  v17 = v15;
  v18 = v15;
  v19 = v15;
  v20 = v15;
  v21 = v15;
  v22 = v15;
  v23 = v15;
  v24 = v15;
  v25 = v15;
  v26 = v15;
  v27 = v1;
  __printf_chk(1, "You got: %u out of %u\n", v1, i);
  if ( 101 - v1 <= (unsigned int)dword_804C0A8 )
    dword_804C0A8 = dword_804C0A8 + v1 - 101;
  else
    dword_804C0A8 = 0;
  if ( !dword_804C0A8 )
    return lose();
  __printf_chk(1, "Remaining balance: $%d\n", dword_804C0A8);
  __printf_chk(1, "Continue? [Y/n]");
  fflush(stdout);
  __isoc99_scanf("%3[^\n]", v6);
  flush_stdin();
  v8 = 16843009 * v7;
  v9 = v8;
  v10 = v8;
  v11 = v8;
  v12 = v8;
  v13 = v7;
  if ( v6[0] == 110 || v6[0] == 78 )
  {
    puts("So long, and thanks for all the money!");
    return 1;
  }
  else
  {
    __printf_chk(1, "\nThis was lucky number: %u\n", dword_804C0A4);
    return 0;
  }
}
// 8049100: using guessed type int __printf_chk(_DWORD, const char *, ...);
// 8049110: using guessed type int __isoc99_scanf(const char *, ...);
// 804C0A4: using guessed type int dword_804C0A4;
// 804C0A8: using guessed type int dword_804C0A8;
// 804937A: using guessed type int var_E0[36];
// 804937A: using guessed type char var_F9[2];

//----- (08049607) --------------------------------------------------------
unsigned int __cdecl mix(int a1, int a2, unsigned int a3)
{
  int v3; // ecx
  unsigned int v4; // eax
  unsigned int v5; // edx
  int v6; // ecx
  unsigned int v7; // eax
  unsigned int v8; // edx
  int v9; // ecx

  v3 = (a1 - a2 - a3) ^ (a3 >> 13);
  v4 = (a2 - a3 - v3) ^ (v3 << 8);
  v5 = (a3 - v3 - v4) ^ (v4 >> 13);
  v6 = (v3 - v4 - v5) ^ (v5 >> 12);
  v7 = (v4 - v5 - v6) ^ (v6 << 16);
  v8 = (v5 - v6 - v7) ^ (v7 >> 5);
  v9 = (v6 - v7 - v8) ^ (v8 >> 3);
  return (v8 - v9 - ((v7 - v8 - v9) ^ (v9 << 10))) ^ (((v7 - v8 - v9) ^ (v9 << 10)) >> 15);
}

//----- (08049685) --------------------------------------------------------
int __cdecl main(int argc, const char **argv, const char **envp)
{
  unsigned int v3; // esi
  int v4; // ebx
  int v5; // eax
  unsigned int v6; // eax
  int v7; // eax

  puts("Welcome to the Saint Tropez Virtual Casino!");
  v3 = getpid();
  v4 = time(0);
  v5 = clock();
  v6 = mix(v5, v4, v3);
  srand(v6);
  puts("First, enter your age:");
  fflush(stdout);
  __isoc99_scanf("%u", &dword_804C0AC);
  if ( (unsigned int)dword_804C0AC <= 0x11 )
  {
    puts("You are not allowed to play!");
    return 1;
  }
  else
  {
    flush_stdin();
    puts("Please enter your name:");
    fflush(stdout);
    __isoc99_scanf("%[^\n]", cur_user);
    if ( !strncmp(cur_user, "Florin Salam", 0xCu) )
    {
      puts("https://www.youtube.com/watch?v=tXO2QtjixaM");
      puts("Hai in vacanteeeee!\n");
      dword_804C0A8 = 5 * (rand() % 66) + 6000;
    }
    else
    {
      dword_804C0A8 = 250;
    }
    while ( 1 )
    {
      v7 = loop();
      if ( v7 < 0 )
        break;
      if ( v7 )
        return 0;
    }
    return -v7;
  }
}
// 8049110: using guessed type int __isoc99_scanf(const char *, ...);
// 804C0A8: using guessed type int dword_804C0A8;
// 804C0AC: using guessed type int dword_804C0AC;

//----- (080497D0) --------------------------------------------------------
void term_proc()
{
  ;
}

// nfuncs=49 queued=17 decompiled=17 lumina nreq=0 worse=0 better=0
// ALL OK, 17 function(s) have been successfully decompiled
